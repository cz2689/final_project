---
title: "Statistical Analysis"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---
```{r, message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
library(tidyverse)

```

```{r, message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
data = read_csv("./data/nsduh_19.csv")
reg = data %>% 
  mutate(
    ymdelt = replace_na(ymdelt, 0),
         amdelt = replace_na(amdelt, 0),
         drp = ymdelt + amdelt,
         mrjmon = as.factor(mrjmon),
         mrjmon = fct_relevel(mrjmon, "0"),
         drp = na_if(drp, 0),
         drp = as.factor(drp),
         drp = fct_relevel(drp, "2"),
         irsex = as.factor(irsex),
         newrace2 = as.factor(newrace2),
         eduhighcat = as.factor(eduhighcat),
         coutyp4 = as.factor(coutyp4),
         income = as.factor(income),
         irmarit = as.factor(irmarit)
         )
```

# Logistic regression
We perform a logistic regression on our outcome and exposure while adjusting for other covariates.  
Drp (depression) = mrjmon (Past month marijuana Use) + catag6 (age) + irsex (sex) + newrace2 (race)  + eduhighcat (education) + coutyp4 (region) + income (income) + irmarit (martial status)  
And the resulting odds ratio is shown below:
```{r}
reg %>% 
  glm(drp ~ mrjmon + catag6 + irsex + newrace2 + eduhighcat + coutyp4 + income + irmarit, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         conf.low = exp((estimate - 1.96 * std.error)),
         conf.high = exp((estimate + 1.96 * std.error))
         ) %>%
  filter(term == "mrjmon1") %>% 
  select(term, OR, conf.low, conf.high) %>% 
  knitr::kable(digits = 3)
```
The odds of depression is 1.901 (95% CI: 1.794 - 2.015) comparing people who used cannabis in the past month to those who do not adjusting for age, sex, race, education, region, income, and martial status. 


# Hypothesis testing 
Is the beta for our exposure variable truly different from zero?  
We obtained the p.value from the t.test statistics.
```{r}
reg %>% 
  glm(drp ~ mrjmon + catag6 + irsex + newrace2 + eduhighcat + coutyp4 + income + irmarit, data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  filter(term == "mrjmon1") %>% 
  select(term, statistic, p.value) %>% 
  knitr::kable(digits = 4)
```
As we can see that the t-tests statistic for the term `mrjmon1` which is marijuana past month use comparing Yes to No is very large and the resulting p.value is close to zero. Our beta coefficient of the exposure variable is significant. 

```{r}
reg %>% 
mutate(coutyp4 = as.character(coutyp4),
    coutyp4 = recode(coutyp4, 
                     "1" = "Large Metro", "2" = "Small Metro", "3" = "Nonmetro"),
    coutyp4 = fct_relevel(coutyp4, "Large Metro", "Small Metro", "Nonmetro")) %>% 
  group_by(coutyp4) %>% 
    summarise( youth = round(sum(youth_dpr, na.rm=TRUE)/n()*100, 2),
               adult = round(sum(adult_dpr, na.rm=TRUE)/n()*100, 2))
```





